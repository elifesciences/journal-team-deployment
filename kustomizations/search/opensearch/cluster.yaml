---
apiVersion: opensearch.opster.io/v1
kind: OpenSearchCluster
metadata:
  name: opensearch
  namespace: journal
spec:
  confMgmt:
    smartScaler: true
  general:
    image: public.ecr.aws/opensearchproject/opensearch:${opensearch_version}
    serviceName: opensearch
    serviceAccount: opensearch
    version: ${opensearch_version}
    monitoring:
      enable: false
    pluginsList:
    - "https://github.com/aiven/prometheus-exporter-plugin-for-opensearch/releases/download/${opensearch_version}.0/prometheus-exporter-${opensearch_version}.0.zip"
    - "repository-s3"
    snapshotRepositories:
    - name: ${aws_backup_s3_bucket}
      type: s3
      settings:
        bucket: ${aws_backup_s3_bucket}
        region: ${aws_region}
        base_path: journal/search/${env}/opensearch
    # This is to work around JRE permission issues, see https://github.com/opensearch-project/opensearch-k8s-operator/issues/442
    additionalConfig:
      s3.client.default.identity_token_file: /usr/share/opensearch/config/aws-iam-token
      AWS_ROLE_ARN: arn:aws:iam::512686554592:role/elife-flux-prod-backups-cluster-role
      AWS_WEB_IDENTITY_TOKEN_FILE: /usr/share/opensearch/config/aws-iam-token
    additionalVolumes:
    - name: sa-aws-iam-token
      path: /usr/share/opensearch/config/aws-iam-token
      subPath: token
      projected:
        sources:
        - serviceAccountToken:
            audience: sts.amazonaws.com
            expirationSeconds: 2592000 # 60s*60m*24h*30d
            path: token
  security:
    config:
      securityConfigSecret:
        name: opensearch-securityconfig
      adminCredentialsSecret:
        name: opensearch-admin-creds
    tls:
      transport:
        generate: true
      http:
        generate: true
  dashboards:
    version: ${opensearch_version}
    image: public.ecr.aws/opensearchproject/opensearch-dashboards:${opensearch_version}
    enable: true
    replicas: 1
    resources:
      requests:
        memory: "256Mi"
        cpu: "210m"
      limits:
        memory: "256Mi"
  nodePools:
  - component: managers
    replicas: ${opensearch_manager_replicas:-1}
    resources:
      requests:
        memory: "${opensearch_manager_request_mem:-2938Mi}"
        cpu: "${opensearch_manager_request_cpu:-100m}"
      limits:
        memory: "${opensearch_manager_limit_mem:-2938Mi}"
    roles:
    - "cluster_manager"
    diskSize: 5Gi
    topologySpreadConstraints:
    - maxSkew: 1
      topologyKey: kubernetes.io/hostname
      whenUnsatisfiable: DoNotSchedule
      labelSelector:
        matchLabels:
          opster.io/opensearch-cluster: opensearch
          opster.io/opensearch-nodepool: managers
    pdb:
      enable: true
      maxUnavailable: 1
    persistence:
      pvc:
        storageClass: journal-gp3
        accessModes:
          - ReadWriteOnce
  - component: data
    replicas: ${opensearch_data_replicas:-1}
    resources:
      requests:
        memory: "${opensearch_data_request_mem:-5102Mi}"
        cpu: "${opensearch_data_request_cpu:-3500m}"
      limits:
        memory: "${opensearch_data_limit_mem:-5102Mi}"
    roles:
    - "data"
    diskSize: 30Gi
    topologySpreadConstraints:
    - maxSkew: 1
      topologyKey: kubernetes.io/hostname
      whenUnsatisfiable: DoNotSchedule
      labelSelector:
        matchLabels:
          opster.io/opensearch-cluster: opensearch
          opster.io/opensearch-nodepool: data
    pdb:
      enable: true
      maxUnavailable: 1
    persistence:
      pvc:
        storageClass: journal-gp3
        accessModes:
          - ReadWriteOnce
