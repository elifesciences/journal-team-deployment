geo $dollar {
    default "$";
}
map $http_x_forwarded_host $robots_disallow {
    default "/";
    "~^(?<first_host>(?:[^,]+\.)?elifesciences\.org)\s*(?:,|$)" "";
}
map $http_x_forwarded_host $http_x_forwarded_host_filtered {
    default "";
    "~^(?<first_host>(?:[^,]+\.)?elifesciences.org)\s*(?:,|$)" $first_host;
}
server {
    server_name localhost;
    listen 80 default_server;
    root /srv/journal/web;

    # TODO: sitemap/rss observer
    # TODO: EPP
    # TODO: PubPub
    # TODO: error pages

    location ~ \..*/.*\.php$ {
        return 403;
    }

    location / {
        try_files $uri /app.php$is_args$query_string;
        add_header Cache-Control "public, max-age=604800";

        rewrite '^/(?:cgi|content|elife)/.+?/(?:e|eLife\.)?([0-9]{5,})(v[0-9]+)?' '{{ public_scheme }}://{{ public_host }}/articles/$1$2' permanent;
        rewrite '^/keywords/(.*)$' '{{ public_scheme }}://{{ public_host }}/search?for=$1' permanent;
        rewrite '^/(.*)/$' '{{ public_scheme }}://{{ public_host }}/$1' permanent;
        rewrite '^/About$' '{{ public_scheme }}://{{ public_host }}/about' permanent;
        rewrite '^/Community$' '{{ public_scheme }}://{{ public_host }}/community' permanent;
        rewrite '^/Events$' '{{ public_scheme }}://{{ public_host }}/events' permanent;
        rewrite '^/Labs$' '{{ public_scheme }}://{{ public_host }}/labs' permanent;

        # rewrite to external URLs have to go here
        rewrite '^/highlights$' 'https://crm.elifesciences.org/crm/highlights' permanent;
        rewrite '^/inside-elife/719e655d/elife-latest-the-costs-of-publishing$' 'https://reviewer.elifesciences.org/author-guide/fees' permanent;
        rewrite '^/inside-elife/719e655d$' 'https://reviewer.elifesciences.org/author-guide/fees' permanent;
        rewrite '^/inside-elife/a058ec77/what-it-costs-to-publish$' 'https://reviewer.elifesciences.org/author-guide/fees' permanent;
        rewrite '^/inside-elife/a058ec77$' 'https://reviewer.elifesciences.org/author-guide/fees' permanent;
        rewrite '^/inside-elife/b6365b76/setting-a-fee-for-publication$' 'https://reviewer.elifesciences.org/author-guide/fees' permanent;
        rewrite '^/inside-elife/b6365b76$' 'https://reviewer.elifesciences.org/author-guide/fees' permanent;
        rewrite '^/for-the-press/d5b3c1bf/elife-introduces-first-demonstration-of-the-open-source-publishing-platform-libero-publisher$' 'https://libero.pub/products/libero-publisher' permanent;
        rewrite '^/for-the-press/d5b3c1bf$' 'https://libero.pub/products/libero-publisher/' permanent;
        rewrite '^/inside-elife/388456f7$' 'https://docs.google.com/forms/d/e/1FAIpQLSf2_AAER-DpV0QjLcyvj7qE5V27t9LVaPqClPDiqqnLAiuJJw/viewform' permanent;
        rewrite '^/inside-elife/388456f7/statement-from-plurality-of-elife-editors$' 'https://docs.google.com/forms/d/e/1FAIpQLSf2_AAER-DpV0QjLcyvj7qE5V27t9LVaPqClPDiqqnLAiuJJw/viewform' permanent;
        rewrite '^/submit[/]*$' 'https://elife-rp.msubmit.net/' permanent;

        if ($new_uri) {
            return 301 {{ public_scheme }}://{{ public_host }}$new_uri;
        }
    }

    location /robots.txt {
        add_header Content-Type text/plain;
        return 200 "User-agent: *\nDisallow: $robots_disallow\nDisallow: /search\nDisallow: /download/\nCrawl-delay: 10\n\nUser-agent: Googlebot\nDisallow: /*.ris\nDisallow: /*.bib\nAllow: /search$dollar\nDisallow: /search?\nDisallow: /download/\n\nUser-agent: Amazonbot\nDisallow: /\n\nUser-agent: SemrushBot\nDisallow: /\n\nUser-agent: MJ12bot\nDisallow: /\n\nUser-agent: trendkite-akashic-crawler\nDisallow: /\n\nUser-agent: Seekport Crawler\nDisallow: /\n\nUser-agent: Linespider\nDisallow: /\n\nSitemap: https://elifesciences.org/sitemap.xml\n\n";
    }
    location /ping {
        add_header Cache-Control "must-revalidate, no-cache, no-store, private";
        add_header Content-Type "text/plain; charset=UTF-8";
        return 200 "pong";
    }

    location ~ ^/app\.php(/|$) {
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $request_filename;
        fastcgi_param DOCUMENT_ROOT $realpath_root;
        # supported environment for the ap
        fastcgi_param ENVIRONMENT_NAME ${env};
        fastcgi_param APP_ENV ${env};
        fastcgi_param APP_ELB true;

        fastcgi_param HTTP_X_FORWARDED_HOST $http_x_forwarded_host_filtered if_not_empty;

        fastcgi_intercept_errors on;
        fastcgi_pass localhost:9000;
        internal;
    }
}
