---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: journal-cms-database
  namespace: journal--test

spec:
  interval: 1m
  releaseName: journal-cms-database
  chart:
    spec:
      chart: pxc-db
      version: 1.18.0
      sourceRef:
        kind: HelmRepository
        name: percona
        namespace: db-operator-system
      interval: 1m

  values:
    pause: false
    backup:
      enabled: true
      serviceAccountName: journal-cms-database
      storages:
        journal-cms-prod-backups:
          type: s3
          s3:
            bucket: "${aws_backup_s3_bucket}/journal-cms/prod"
            region: "${aws_region}"
      schedule:
        # - name: "daily-backup"
        #   schedule: "0 0 * * *"
        #   storageName: journal-cms-prod-backups
        #   retention:
        #     count: 30
        #     type: count
        #     deleteFromStorage: true
    pxc:
      nodeSelector:
        kubernetes.io/arch: amd64
      # request certs with cert-manager, not helm charts
      certManager: true
      configuration: |
        [mysqld]
        sort_buffer_size=4M
      resources:
        requests:
          memory: 1.2Gi
          cpu: 200m
      persistence:
        storageClass: journal-gp3
        size: 20Gi
      readinessProbes:
        initialDelaySeconds: 300
        failureThreshold: 10
      livenessProbes:
        initialDelaySeconds: 300
        failureThreshold: 10
    haproxy:
      nodeSelector:
        kubernetes.io/arch: amd64
      resources:
        requests:
          memory: 25Mi
          cpu: 200m
    logcollector:
      resources:
        requests:
          memory: 15Mi
          cpu: 10m
